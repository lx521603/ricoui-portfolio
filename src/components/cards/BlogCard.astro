---
/**
 * Extended Blog Card with dynamic aspect ratio
 */
const {
  content,
  layout = "vertical",
  "data-aos": dataAos,
  "data-aos-delay": dataAosDelay,
  mediaRatio,
} = Astro.props;

const {
  title,
  description,
  publishDate,
  tags = [] as string[],
  img,
  img_alt,
  slug,
  link,
  video
} = content;

const formattedDate = new Date(publishDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric'
});

const postLink = link || `/blog/${slug}`;
const isHorizontal = layout === "horizontal";

const ratioMap: Record<string, string> = {
  "4:3": "aspect-[4/3]",
  "3:4": "aspect-[3/4]",
  "16:9": "aspect-[16/9]",
  "9:16": "aspect-[9/16]",
  "1:1": "aspect-square",
};

let computedRatio = isHorizontal ? "3:4" : "4:3";
if (mediaRatio) computedRatio = mediaRatio;

const useAspect = computedRatio !== "auto";
const aspectClass = useAspect ? ratioMap[computedRatio] : "";

const mediaClass =
  computedRatio === "auto"
    ? "w-full h-auto object-contain transition-transform duration-500 group-hover:scale-105"
    : "w-full h-full object-cover transition-transform duration-500 group-hover:scale-105";

const videoId = video ? `blogcard-video-${slug.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}` : null;
---

<article
  class:list={[
    "group relative overflow-hidden bg-bg-secondary border-primary/35 p-4 dark:bg-neutral-900 rounded-2xl backdrop-blur-sm transition-all duration-500",
    { "md:flex md:items-center": isHorizontal }
  ]}
  data-aos={dataAos}
  data-aos-delay={dataAosDelay}
>

  <div class:list={[
      "relative overflow-hidden rounded-2xl dark:border-neutral-800/60 border-4 border-white",
      isHorizontal ? "md:w-1/2" : "",
      aspectClass
    ]}
  >
    {video ? (
      <video
        id={videoId}
        src={video}
        poster={img}
        autoplay
        loop
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        controls={false}
        disablepictureinpicture
        controlslist="nodownload noplaybackrate nofullscreen noremoteplayback"
        class={mediaClass}
      >
        <source src={video} type="video/mp4" />
      </video>
    ) : img ? (
      <img src={img} alt={img_alt || `Related to ${title}`} loading="lazy" class={mediaClass} />
    ) : (
      <div class="w-full h-full flex items-center justify-center bg-neutral-200 dark:bg-neutral-700">
        <!-- fallback icon -->
      </div>
    )}

    <a class="absolute inset-0 z-10" href={postLink}></a>
  </div>

  <div class:list={[
      "p-6 px-2 md:p-6 flex flex-col",
      isHorizontal ? "md:w-1/2" : ""
    ]}
  >
    <div class="flex items-center text-sm mb-4 gap-2">
      <time class="inline-flex items-center text-neutral-500 dark:text-neutral-400 text-xs">
        {formattedDate}
      </time>

      {tags.length > 0 && (
        <>
          <span class="text-neutral-400 dark:text-neutral-500">·</span>
          <span class="inline-flex items-center rounded-full bg-bg-secondary/8 dark:bg-bg-secondary/15 px-3 py-1 text-[11px] font-light text-primary/75 dark:text-primary-light/85 border border-primary/25 dark:border-primary/25">
            {tags[0]}
          </span>
        </>
      )}
    </div>

    <a href={postLink}>
      <h2 class:list={[
        "font-brand text-neutral-900 dark:text-white mb-3 leading-tight line-clamp-2",
        isHorizontal ? "text-3xl" : "text-2xl"
      ]}>
        {title}
      </h2>
    </a>

    {description && (
      <p class="text-neutral-600 dark:text-neutral-400 line-clamp-3 mb-5 text-sm leading-relaxed">
        {description}
      </p>
    )}

    <div class="mt-auto pt-4">
      <a href={postLink} class="inline-flex items-center gap-2 text-sm font-semibold text-primary dark:text-primary-light">
        阅读全文 →
      </a>
    </div>
  </div>

</article>

{video && (
  <script define:vars={{ videoId }}>
    // same autoplay handler as original
  </script>
)}