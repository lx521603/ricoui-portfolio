---
/**
 * Feature-rich BlogCard
 *
 * Expects content object with:
 *  title, description, publishDate, tags (string[]), img, img_alt, slug, link, video
 */
const {
  content,
  layout = "vertical",
  "data-aos": dataAos,
  "data-aos-delay": dataAosDelay,
  mediaRatio = "4:3",
} = Astro.props || {};

const {
  title = "",
  description = "",
  publishDate,
  tags = [],
  img,
  img_alt,
  slug = "",
  link,
  video
} = content || {};

const postLink = link || (slug ? `/blog/${slug}` : "/blog");
const isHorizontal = layout === "horizontal";

const ratioMap = {
  "4:3": "aspect-[4/3]",
  "3:4": "aspect-[3/4]",
  "16:9": "aspect-[16/9]",
  "9:16": "aspect-[9/16]",
  "1:1": "aspect-square",
};

const computedRatio = mediaRatio || (isHorizontal ? "3:4" : "4:3");
const useAspect = computedRatio !== "auto";
const aspectClass = useAspect ? (ratioMap[computedRatio] ?? ratioMap["4:3"]) : "";

const mediaClass =
  computedRatio === "auto"
    ? "w-full h-auto object-contain transition-transform duration-500 group-hover:scale-105"
    : "w-full h-full object-cover transition-transform duration-500 group-hover:scale-105";

const videoId = video && slug ? `blogcard-video-${slug.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}` : null;

const formattedDate = publishDate ? new Date(publishDate).toLocaleDateString("zh-CN", {
  year: 'numeric', month: 'short', day: 'numeric'
}) : "";
---
<article
  class:list={[
    "group relative overflow-hidden rounded-2xl bg-bg-secondary/30 dark:bg-neutral-900 transition-all duration-300",
    { "md:flex md:items-center": isHorizontal }
  ]}
  data-aos={dataAos}
  data-aos-delay={dataAosDelay}
>
  <!-- media -->
  <div class:list={[
    "relative overflow-hidden rounded-2xl border border-transparent",
    isHorizontal ? "md:w-1/2" : "",
    aspectClass
  ]}>
    {video ? (
      <video
        id={videoId}
        src={video}
        poster={img}
        autoplay
        loop
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        controls={false}
        disablepictureinpicture
        controlslist="nodownload noplaybackrate nofullscreen noremoteplayback"
        class={mediaClass}
      >
        <source src={video} type="video/mp4" />
      </video>
    ) : img ? (
      <img src={img} alt={img_alt || title} loading="lazy" class={mediaClass} />
    ) : (
      <div class="w-full h-full flex items-center justify-center bg-neutral-200 dark:bg-neutral-700">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-400">
          <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
          <circle cx="9" cy="9" r="2"></circle>
          <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
        </svg>
      </div>
    )}

    <a class="absolute inset-0 z-10" href={postLink} aria-label={`阅读：${title}`}></a>
  </div>

  <!-- content -->
  <div class:list={[
    "p-6 flex flex-col",
    isHorizontal ? "md:w-1/2" : ""
  ]}>
    <div class="flex items-center text-sm mb-3 gap-3">
      {formattedDate && (
        <time class="text-neutral-500 dark:text-neutral-400 text-xs">{formattedDate}</time>
      )}

      {tags && tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <a
              href={`/blog/tag/${encodeURIComponent(tag)}`}
              class="px-2 py-0.5 text-xs rounded-full bg-neutral-100 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition"
              aria-label={`标签：${tag}`}
            >
              #{tag}
            </a>
          ))}
        </div>
      )}
    </div>

    <a href={postLink}>
      <h3 class:list={[
        "font-brand text-neutral-900 dark:text-white mb-2 leading-tight group-hover:text-primary transition",
        isHorizontal ? "text-2xl" : "text-xl"
      ]}>
        {title}
      </h3>
    </a>

    {description && (
      <p class="text-neutral-600 dark:text-neutral-400 mb-4 line-clamp-3">
        {description}
      </p>
    )}

    <div class="mt-auto">
      <a href={postLink} class="inline-flex items-center gap-2 text-sm font-semibold text-primary">
        阅读全文
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"></line>
          <polyline points="12 5 19 12 12 19"></polyline>
        </svg>
      </a>
    </div>
  </div>
</article>

{video && videoId && (
  <script is:inline define:vars={{ videoId }}>
    (function () {
      const video = document.getElementById(videoId);
      if (!video || !(video instanceof HTMLVideoElement)) return;
      let isPlaying = false, observer = null, playAttempts = 0;
      const MAX_PLAY_ATTEMPTS = 3;

      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.removeAttribute('controls');

      function tryPlay() {
        if (isPlaying || playAttempts >= MAX_PLAY_ATTEMPTS) return;
        playAttempts++;
        const p = video.play();
        if (p !== undefined) {
          p.then(() => { isPlaying = true; playAttempts = 0; })
           .catch((err) => {
             isPlaying = false;
             if (err && err.name === 'NotAllowedError') setupInteraction();
           });
        }
      }

      function setupInteraction() {
        const events = ['touchstart', 'click', 'scroll'];
        function once() {
          tryPlay();
          events.forEach(e => document.removeEventListener(e, once));
        }
        events.forEach(e => document.addEventListener(e, once, { once: true, passive: true }));
      }

      function setupObserver() {
        observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) { if (video.paused) { playAttempts = 0; tryPlay(); } }
            else { if (!video.paused) { video.pause(); isPlaying = false; } }
          });
        }, { root: null, rootMargin: '50px', threshold: 0.1 });
        observer.observe(video);
      }

      function init() {
        if (video.readyState >= 2) tryPlay();
        else video.addEventListener('loadeddata', tryPlay, { once: true });
        setupObserver();
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden && !video.paused) tryPlay();
        });
      }

      init();
      document.addEventListener('astro:before-preparation', () => {
        if (observer) { observer.disconnect(); observer = null; }
      }, { once: true });
    })();
  </script>
)}