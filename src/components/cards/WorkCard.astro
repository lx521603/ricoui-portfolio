---
/**
 * Complete WorkCard.astro
 *
 * Props:
 * - name: string (required)
 * - image: string (required)  // poster for video or image src
 * - url: string (required)
 * - description?: string
 * - tags?: string[]
 * - video?: string   // optional video src
 * - isShow?: boolean // optional
 * - layout?: 'featured' | 'grid'
 * - index?: number
 * - target?: string
 * - mediaRatio?: '4:3'|'3:4'|'16:9'|'9:16'|'1:1'|'auto'  // default 'auto'
 *
 * This file is self-contained and only modifies this component.
 */

interface Props {
  name: string;
  image: string;
  url: string;
  description?: string;
  tags?: string[];
  video?: string;
  isShow?: boolean;
  layout?: 'featured' | 'grid';
  index?: number;
  target?: string;
  mediaRatio?: '4:3' | '3:4' | '16:9' | '9:16' | '1:1' | 'auto';
}

const {
  name,
  description = '',
  url,
  image,
  tags = [],
  video,
  isShow = true,
  layout = 'grid',
  index = 0,
  target = "_blank",
  mediaRatio = 'auto'
}: Props = Astro.props;

// Generate stable id for each video
const videoId = `workcard-video-${index}-${name.replace(/[^a-z0-9]+/gi, '-').toLowerCase()}`;

// aspect-ratio mapping (used only if not 'auto')
const ratioMap: Record<string, string> = {
  "4:3": "aspect-[4/3]",
  "3:4": "aspect-[3/4]",
  "16:9": "aspect-[16/9]",
  "9:16": "aspect-[9/16]",
  "1:1": "aspect-square",
};

// compute classes
const useAspect = mediaRatio !== 'auto';
const aspectClass = useAspect ? (ratioMap[mediaRatio] ?? ratioMap['4:3']) : '';
const mediaClass = mediaRatio === 'auto'
  ? 'w-full h-auto object-contain transition-transform duration-700 group-hover:scale-105'
  : 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-105';

// ğŸš€ LCP ä¼˜åŒ–é€»è¾‘ï¼šå‡è®¾é¦–é¡µçš„ç¬¬ä¸€ä¸ªå¡ç‰‡ (index === 0) æ˜¯ LCP å…ƒç´ 
const isLcpCandidate = index === 0 && !video;

// âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å†™æ‚¨ LCP å›¾ç‰‡çš„å®é™…å°ºå¯¸ï¼
const LCP_IMAGE_WIDTH = '1200'; // æ›¿æ¢ä¸º LCP å›¾ç‰‡çš„å®é™…åƒç´ å®½åº¦
const LCP_IMAGE_HEIGHT = '800'; // æ›¿æ¢ä¸º LCP å›¾ç‰‡çš„å®é™…åƒç´ é«˜åº¦
---

<article
  class:list={[
    "group relative overflow-hidden transition-all duration-500 mb-8 bg-white/85 p-5 dark:bg-bg-secondary-dark border-[.75px] border-solid border-primary/15 rounded-2xl backdrop-blur-sm",
    layout === 'featured' ? "" : ""
  ]}
  data-aos="fade-up"
  data-aos-duration="500"
  data-aos-delay={index * 100}
  data-aos-once="true"
  aria-hidden={!isShow}
>
  <div class:list={[
    "relative overflow-hidden rounded-xl",
    aspectClass
  ]}>
    {video ? (
      <video
        id={videoId}
        src={video}
        poster={image}
        autoplay
        loop
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        controls={false}
        disablepictureinpicture
        controlslist="nodownload noplaybackrate nofullscreen noremoteplayback"
        class={mediaClass}
      >
        <source src={video} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    ) : (
      <img
        src={image}
        alt={name ?? ''}
        width={isLcpCandidate ? LCP_IMAGE_WIDTH : undefined}   height={isLcpCandidate ? LCP_IMAGE_HEIGHT : undefined} class={mediaClass + " hover:shadow-xl hover:shadow-primary/5 dark:hover:shadow-primary/10"}
        
        loading={isLcpCandidate ? undefined : 'lazy'} fetchpriority={isLcpCandidate ? 'high' : 'auto'} />
    )}

    <div class="absolute inset-0 bg-gradient-to-t from-black/25 via-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500"></div>
    
    </div>

  <div class:list={[
    "px-1 pt-6 pb-2",
    layout === 'featured' ? "md:px-1 md:pt-6 md:pb-2" : ""
  ]}>
    <a
      href={url}
      target={target}
      rel={target === "_blank" ? "noopener noreferrer" : undefined}
      class="absolute inset-0 z-10"
    >
      <span class="sr-only">æŸ¥çœ‹ {name}</span>
    </a>
</article>

{video && (
  <script define:vars={{ videoId }}>
    // ä¿æŒæ‚¨çš„ Intersection Observer è§†é¢‘é€»è¾‘ä¸å˜
    (function() {
      const video = document.getElementById(videoId);
      // ä¿®å¤ï¼šç¡®ä¿ video å…ƒç´ å­˜åœ¨ä¸”ç±»å‹æ­£ç¡®
      if (!video || !(video instanceof HTMLVideoElement)) return;
      let isPlaying = false, observer = null, playAttempts = 0;
      const MAX_PLAY_ATTEMPTS = 3;

      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      video.removeAttribute('controls');

      function tryPlay() {
        if (isPlaying || playAttempts >= MAX_PLAY_ATTEMPTS) return;
        playAttempts++;
        const playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.then(()=>{isPlaying=true; playAttempts=0;})
            .catch((error)=>{isPlaying=false;
              if (error?.name==='NotAllowedError'){handleUserInteraction();}});
        }
      }

      function handleUserInteraction() {
        ['touchstart','click','scroll'].forEach(ev=>{
          document.addEventListener(ev,function onInteraction(){
            tryPlay();
            ['touchstart','click','scroll'].forEach(event=>document.removeEventListener(event,onInteraction));
          },{once:true,passive:true});
        });
      }

      function setupIntersectionObserver() {
        observer = new IntersectionObserver((entries)=>{
          entries.forEach(entry=>{
            if(entry.isIntersecting){if(video.paused){playAttempts=0;tryPlay();}}
            else{if(!video.paused){video.pause();isPlaying=false;}}
          });
        }, {root:null, rootMargin:'50px', threshold:0.1});
        observer.observe(video);
      }

      function handleVisibilityChange() {
        if(!document.hidden && !video.paused){
          const rect = video.getBoundingClientRect();
          if(rect.top<window.innerHeight && rect.bottom>0){playAttempts=0; tryPlay();}
        }
      }

      function init() {
        if(video.readyState>=2){tryPlay();}
        else{video.addEventListener('loadeddata',tryPlay,{once:true});}
        setupIntersectionObserver();
        document.addEventListener('visibilitychange',handleVisibilityChange);
      }

      function cleanup(){if(observer){observer.disconnect();observer=null;}document.removeEventListener('visibilitychange',handleVisibilityChange);}

      init();
      document.addEventListener('astro:before-preparation',cleanup,{once:true});
    })();
  </script>
)}
