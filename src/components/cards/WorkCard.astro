---
/**
 * Complete WorkCard.astro
 *
 * Props:
 * - name: string (required)
 * - image: string (required)  // poster for video or image src
 * - url: string (required)
 * - description?: string
 * - tags?: string[]
 * - video?: string   // optional video src
 * - isShow?: boolean // optional
 * - layout?: 'featured' | 'grid'
 * - index?: number
 * - target?: string
 * - mediaRatio?: '4:3'|'3:4'|'16:9'|'9:16'|'1:1'|'auto'  // default 'auto'
 *
 * This file is self-contained and only modifies this component.
 */

interface Props {
  name: string;
  image: string;
  url: string;
  description?: string;
  tags?: string[];
  video?: string;
  isShow?: boolean;
  layout?: 'featured' | 'grid';
  index?: number;
  target?: string;
  mediaRatio?: '4:3' | '3:4' | '16:9' | '9:16' | '1:1' | 'auto';
}

const {
  name,
  description = '',
  url,
  image,
  tags = [],
  video,
  isShow = true,
  layout = 'grid',
  index = 0,
  target = "_blank",
  mediaRatio = 'auto'
}: Props = Astro.props;

// Generate stable id for each video
const videoId = `workcard-video-${index}-${name.replace(/[^a-z0-9]+/gi, '-').toLowerCase()}`;

// aspect-ratio mapping (used only if not 'auto')
const ratioMap: Record<string, string> = {
  "4:3": "aspect-[4/3]",
  "3:4": "aspect-[3/4]",
  "16:9": "aspect-[16/9]",
  "9:16": "aspect-[9/16]",
  "1:1": "aspect-square",
};

// compute classes
const useAspect = mediaRatio !== 'auto';
const aspectClass = useAspect ? (ratioMap[mediaRatio] ?? ratioMap['4:3']) : '';
const mediaClass = mediaRatio === 'auto'
  ? 'w-full h-auto object-contain transition-transform duration-700 group-hover:scale-105'
  : 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-105';
---

<article
  class:list={[
    "group relative overflow-hidden transition-all duration-500 mb-8 bg-white/85 p-5 dark:bg-bg-secondary-dark border-[.75px] border-solid border-primary/15 rounded-2xl backdrop-blur-sm",
    layout === 'featured' ? "" : ""
  ]}
  data-aos="fade-up"
  data-aos-duration="500"
  data-aos-delay={index * 100}
  data-aos-once="true"
  aria-hidden={!isShow}
>
  <div class:list={[
    "relative overflow-hidden rounded-xl",
    aspectClass
  ]}>
    {video ? (
      <video
        id={videoId}
        src={video}
        poster={image}
        autoplay
        loop
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        controls={false}
        disablepictureinpicture
        controlslist="nodownload noplaybackrate nofullscreen noremoteplayback"
        class={mediaClass}
      >
        <source src={video} type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    ) : (
      <img
        src={image}
        alt={name ?? ''}
        class={mediaClass + " hover:shadow-xl hover:shadow-primary/5 dark:hover:shadow-primary/10"}
        loading="lazy" 
      />
    )}

    <div class="absolute inset-0 bg-gradient-to-t from-black/25 via-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500"></div>

    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-500">
      <div class="flex items-center justify-center w-14 h-14 rounded-full bg-white/95 backdrop-blur-sm shadow-lg transform translate-y-8 group-hover:translate-y-0 transition-all duration-500 group-hover:scale-110">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="text-primary"
        >
          <path d="M7 7h10v10"></path>
          <path d="M7 17 17 7"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class:list={[
    "px-1 pt-6 pb-2",
    layout === 'featured' ? "md:px-1 md:pt-6 md:pb-2" : ""
  ]}>
    <div class="flex items-start justify-between gap-3 mb-3">
      <h3 class:list={[
        "text-neutral-900 dark:text-white leading-tight font-brand transition-colors duration-300 group-hover:text-primary dark:group-hover:text-primary-light",
        layout === 'featured' ? "text-2xl md:text-3xl" : "text-2xl"
      ]}>
        {name}
      </h3>

      <div class="flex-shrink-0 mt-1">
        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/10 dark:bg-primary/20 text-primary dark:text-primary-light transition-all duration-300 group-hover:bg-primary dark:group-hover:bg-primary-light group-hover:text-white dark:group-hover:text-neutral-900 group-hover:rotate-45">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M7 7h10v10"></path>
            <path d="M7 17 17 7"></path>
          </svg>
        </div>
      </div>
    </div>

    {tags && tags.length > 0 && (
      <div class="flex flex-wrap gap-1.5 mb-3 relative z-20">
        {tags.map((tag) => (
          <a
            href={`/tags/${tag}/`}
            class="inline-flex items-center rounded-full bg-primary/8 dark:bg-primary/15 px-2.5 py-0.5 text-[10px] font-medium text-primary-dark dark:text-primary-light border border-primary/10 dark:border-primary/20 hover:bg-primary/20 dark:hover:bg-primary/30 hover:border-primary/30 dark:hover:border-primary/40 transition-all duration-300 cursor-pointer relative z-20"
            onclick="event.stopPropagation();"
          >
            {tag}
          </a>
        ))}
      </div>
    )}

    {description && (
      <p class:list={[
        "text-neutral-600 dark:text-neutral-400 leading-relaxed",
        layout === 'featured' ? "text-base md:text-lg line-clamp-2" : "text-sm line-clamp-2"
      ]}>
        {description}
      </p>
    )}
  </div>

  <a
    href={url}
    target={target}
    rel={target === "_blank" ? "noopener noreferrer" : undefined}
    class="absolute inset-0 z-10"
  >
    <span class="sr-only">查看 {name}</span>
  </a>
</article>

{video && (
  <script define:vars={{ videoId }}>
    // 保持您的 Intersection Observer 视频逻辑不变
    (function() {
      const video = document.getElementById(videoId);
      // 修复：确保 video 元素存在且类型正确
      if (!video || !(video instanceof HTMLVideoElement)) return;
      let isPlaying = false, observer = null, playAttempts = 0;
      const MAX_PLAY_ATTEMPTS = 3;

      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      video.removeAttribute('controls');

      function tryPlay() {
        if (isPlaying || playAttempts >= MAX_PLAY_ATTEMPTS) return;
        playAttempts++;
        const playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise.then(()=>{isPlaying=true; playAttempts=0;})
            .catch((error)=>{isPlaying=false;
              if (error?.name==='NotAllowedError'){handleUserInteraction();}});
        }
      }

      function handleUserInteraction() {
        ['touchstart','click','scroll'].forEach(ev=>{
          document.addEventListener(ev,function onInteraction(){
            tryPlay();
            ['touchstart','click','scroll'].forEach(event=>document.removeEventListener(event,onInteraction));
          },{once:true,passive:true});
        });
      }

      function setupIntersectionObserver() {
        observer = new IntersectionObserver((entries)=>{
          entries.forEach(entry=>{
            if(entry.isIntersecting){if(video.paused){playAttempts=0;tryPlay();}}
            else{if(!video.paused){video.pause();isPlaying=false;}}
          });
        }, {root:null, rootMargin:'50px', threshold:0.1});
        observer.observe(video);
      }

      function handleVisibilityChange() {
        if(!document.hidden && !video.paused){
          const rect = video.getBoundingClientRect();
          if(rect.top<window.innerHeight && rect.bottom>0){playAttempts=0; tryPlay();}
        }
      }

      function init() {
        if(video.readyState>=2){tryPlay();}
        else{video.addEventListener('loadeddata',tryPlay,{once:true});}
        setupIntersectionObserver();
        document.addEventListener('visibilitychange',handleVisibilityChange);
      }

      function cleanup(){if(observer){observer.disconnect();observer=null;}document.removeEventListener('visibilitychange',handleVisibilityChange);}

      init();
      document.addEventListener('astro:before-preparation',cleanup,{once:true});
    })();
  </script>
)}
