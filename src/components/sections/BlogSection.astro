---
import BlogCard from "@/components/cards/BlogCard.astro";
import { getCollection } from "astro:content";

const { title = "", description = "", listPage = false, postsPerPage = 6, pagination = { enable: false, currentPage: 1 } } = Astro.props;

let allPosts = await getCollection("post");

// 过滤草稿文章
allPosts = allPosts.filter(p => !p.data?.draft);

// 排序：按发布日期降序
allPosts.sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf());

// 如果有特色文章，需要从列表中排除
const featuredPost = allPosts.find(post => post.data.featured);
if (featuredPost) allPosts = allPosts.filter(p => p.data.featured !== true);

// 分页逻辑
let paginatedPosts = allPosts;
const currentPage = pagination?.currentPage ?? 1;

if (pagination?.enable) {
  const start = (currentPage - 1) * postsPerPage;
  const end = start + postsPerPage;
  paginatedPosts = allPosts.slice(start, end);
}

const totalPages = Math.ceil(allPosts.length / postsPerPage);
---

<section class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
  {paginatedPosts.map(post => (
    <BlogCard content={{
      ...post.data,
      slug: post.id,
      link: `/blog/${post.id}`
    }} />
  ))}
</section>

{pagination?.enable && totalPages > 1 && (
  <div class="mt-8 flex justify-center gap-3">
    {Array.from({ length: totalPages }, (_, i) => {
      const pageNum = i + 1;
      return (
        <a
          class:list={[
            "px-3 py-1 rounded-md border border-primary/25 dark:border-primary/40 transition-colors duration-300",
            pageNum === currentPage ? "bg-primary text-white dark:bg-primary-light dark:text-neutral-900" : "text-neutral-700 dark:text-neutral-300 hover:bg-primary/10 dark:hover:bg-primary-light/10"
          ]}
          href={`/blog/page/${pageNum}`}
        >
          {pageNum}
        </a>
      );
    })}
  </div>
)}