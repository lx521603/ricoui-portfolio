---
import Layout from "@/layouts/Layout.astro";
import PageHeader from "@/components/elements/PageHeader.astro";
import { getCollection } from "astro:content";
import works from "@/collections/featuredwork.json";

// 获取博客文章的标签
const allPosts = await getCollection("post");
const blogTagCounts = {};
allPosts.forEach(post => {
  if (post.data.tags && Array.isArray(post.data.tags)) {
    post.data.tags.forEach(tag => {
      blogTagCounts[tag] = (blogTagCounts[tag] || 0) + 1;
    });
  }
});

// 获取作品的标签
const workTagCounts = {};
works.forEach(work => {
  if (work.tags && Array.isArray(work.tags) && work.isShow !== false) {
    work.tags.forEach(tag => {
      workTagCounts[tag] = (workTagCounts[tag] || 0) + 1;
    });
  }
});

// 合并所有标签
const allTagCounts = {};
[...Object.keys(blogTagCounts), ...Object.keys(workTagCounts)].forEach(tag => {
  allTagCounts[tag] = (blogTagCounts[tag] || 0) + (workTagCounts[tag] || 0);
});

// 按文章数量排序
const tags = Object.entries(allTagCounts)
  .map(([tag, count]) => ({ tag, count: count as number }))
  .sort((a, b) => (b.count as number) - (a.count as number));

// 调试信息
console.log('博客标签:', blogTagCounts);
console.log('作品标签:', workTagCounts);
console.log('所有标签:', tags);
---

<Layout title="标签" description="按标签浏览文章和作品">
  <section class="site-container m-auto">
    <PageHeader
      title="标签"
      description="按标签浏览文章和作品"
    />
    
    <div class="mt-12">
      {tags.length > 0 ? (
        <div class="flex flex-wrap gap-3 justify-center">
          {tags.map(({ tag, count }) => (
            <a
              href={`/tags/${tag}/`}
              class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors group"
            >
              <span class="font-medium text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">
                {tag}
              </span>
              <span class="ml-2 px-1.5 py-0.5 text-xs bg-white dark:bg-gray-700 rounded-full text-gray-600 dark:text-gray-400">
                {count}
              </span>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center text-gray-500 dark:text-gray-400">
          <p>未找到标签。</p>
        </div>
      )}
    </div>
  </section>
</Layout>