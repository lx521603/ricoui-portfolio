---
import Layout from "@/layouts/Layout.astro";
import BlogSection from "@/components/sections/BlogSection.astro";
import WorkCard from "@/components/cards/WorkCard.astro";
import { getCollection } from "astro:content";
import works from "@/collections/featuredwork.json";

export async function getStaticPaths() {
  const posts = await getCollection("post");
  
  // 收集所有唯一的标签（从博客和作品）
  const allTags = new Set();
  
  // 从博客文章收集标签
  posts.forEach(post => {
    if (post.data.tags && Array.isArray(post.data.tags)) {
      post.data.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // 从作品收集标签
  works.forEach(work => {
    if (work.tags && Array.isArray(work.tags) && work.isShow !== false) {
      work.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // 为每个标签生成路径
  return Array.from(allTags).map(tag => ({
    params: { tag: String(tag) },
    props: { tag: String(tag) }
  }));
}

const { tag } = Astro.params;

// 获取该标签下的所有博客文章
const allPosts = await getCollection("post");
const taggedPosts = allPosts
  .filter(post => post.data.tags && Array.isArray(post.data.tags) && post.data.tags.includes(tag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// 获取该标签下的所有作品
const taggedWorks = works
  .filter(work => work.tags && Array.isArray(work.tags) && work.tags.includes(tag) && work.isShow !== false);

const hasBlogPosts = taggedPosts.length > 0;
const hasWorks = taggedWorks.length > 0;
---

<Layout title={`${tag} - 标签`} description={`包含标签 "${tag}" 的文章和作品`}>
  <!-- 使用和首页完全相同的容器 -->
  <div class="relative site-container z-20 w-full mx-auto mt-8 px-4 md:mt-10 lg:mt-12 xl:px-0">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-4">标签: {tag}</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {taggedPosts.length + taggedWorks.length} 个包含标签 "{tag}" 的内容
        {hasBlogPosts && hasWorks && ` (${taggedPosts.length} 篇文章, ${taggedWorks.length} 个作品)`}
        {hasBlogPosts && !hasWorks && ` (${taggedPosts.length} 篇文章)`}
        {!hasBlogPosts && hasWorks && ` (${taggedWorks.length} 个作品)`}
      </p>
    </div>

    <!-- 博客文章部分 -->
    {hasBlogPosts && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">相关文章</h2>
        <!-- 关键修复：移除 BlogSection 的容器，避免嵌套 -->
        <BlogSection
          title=""
          posts={taggedPosts}
          listPage={true}
          pagination={{ enable: false }}
          container={false}  <!-- 添加这个参数 -->
        />
      </section>
    )}

    <!-- 作品部分 -->
    {hasWorks && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">相关作品</h2>
        <div class="space-y-8 md:space-y-10">
          {taggedWorks.map((work, index) => (
            <WorkCard
              name={work.name}
              description={work.description}
              image={work.image}
              url={work.url}
              tags={work.tags}
              video={work.video || undefined}
              isShow={work.isShow}
              layout="featured"
              index={index}
              mediaRatio="auto"
            />
          ))}
        </div>
      </section>
    )}

    <!-- 如果没有内容 -->
    {!hasBlogPosts && !hasWorks && (
      <div class="text-center text-gray-500 dark:text-gray-400 py-12">
        <p>未找到包含此标签的内容。</p>
      </div>
    )}
  </div>
</Layout>