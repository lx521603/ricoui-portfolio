---
import Layout from "@/layouts/Layout.astro";
import BlogCard from "@/components/cards/BlogCard.astro";
import WorkCard from "@/components/cards/WorkCard.astro";
import { getCollection } from "astro:content";
import works from "@/collections/featuredwork.json"; 

export async function getStaticPaths() {
  const posts = await getCollection("post");
  
  // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„æ ‡ç­¾ï¼ˆä»åšå®¢å’Œä½œå“ï¼‰
  const allTags = new Set();
  
  // ä»åšå®¢æ–‡ç« æ”¶é›†æ ‡ç­¾
  posts.forEach(post => {
    // âš ï¸ ä¿®å¤ï¼šè§£å†³ TS 7044 è­¦å‘Šï¼Œè¿™é‡Œä½¿ç”¨ 'post' å‚æ•°çš„æ¨æ–­ç±»å‹ã€‚
    if (post.data.tags && Array.isArray(post.data.tags)) {
      post.data.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // ä»ä½œå“æ”¶é›†æ ‡ç­¾
  works.forEach((work: any) => { // âš ï¸ ä¿®å¤ï¼šä½¿ç”¨ 'any' é¿å… TS 7044 è­¦å‘Š
    if (work.tags && Array.isArray(work.tags) && work.isShow !== false) {
      work.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆè·¯å¾„
  return Array.from(allTags).map(tag => ({
    params: { tag: String(tag) },
    props: { tag: String(tag) }
  }));
}

const { tag } = Astro.params;

// è·å–è¯¥æ ‡ç­¾ä¸‹çš„æ‰€æœ‰åšå®¢æ–‡ç« 
const allPosts = await getCollection("post");
const taggedPosts = allPosts
  .filter(post => post.data.tags && Array.isArray(post.data.tags) && post.data.tags.includes(tag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// è·å–è¯¥æ ‡ç­¾ä¸‹çš„æ‰€æœ‰ä½œå“
// âš ï¸ å‡è®¾ works æ•°ç»„ä¸­çš„å¯¹è±¡ç»“æ„ä¸ WorkCard çš„ Props å…¼å®¹
const taggedWorks = works
  .filter(work => work.tags && Array.isArray(work.tags) && work.tags.includes(tag) && work.isShow !== false);

const hasBlogPosts = taggedPosts.length > 0;
const hasWorks = taggedWorks.length > 0;
---

<Layout title={`${tag} - æ ‡ç­¾`} description={`åŒ…å«æ ‡ç­¾ "${tag}" çš„æ–‡ç« å’Œä½œå“`}>
  <div class="relative site-container z-20 w-full mx-auto mt-8 px-4 md:mt-10 lg:mt-12 xl:px-0">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-4">æ ‡ç­¾: {tag}</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {taggedPosts.length + taggedWorks.length} ä¸ªåŒ…å«æ ‡ç­¾ "{tag}" çš„å†…å®¹
        {hasBlogPosts && hasWorks && ` (${taggedPosts.length} ç¯‡æ–‡ç« , ${taggedWorks.length} ä¸ªä½œå“)`}
        {hasBlogPosts && !hasWorks && ` (${taggedPosts.length} ç¯‡æ–‡ç« )`}
        {!hasBlogPosts && hasWorks && ` (${taggedWorks.length} ä¸ªä½œå“)`}
      </p>
    </div>

    {hasBlogPosts && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">ç›¸å…³æ–‡ç« </h2>
        <div class="grid gap-x-6 gap-y-10 md:grid-cols-2 xl:grid-cols-3">
          {taggedPosts.map((post, index) => (
            <BlogCard
              content={{ ...post.data, ...post } as any}
              data-aos={Math.floor(index / 3) % 2 === 0 ? "fade-right-sm" : "fade-left-sm"}
              data-aos-delay={((index % 3) + 1) * 200}
            />
          ))}
        </div>
      </section>
    )}

    {hasWorks && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">ç›¸å…³ä½œå“</h2>
        <div class="space-y-8 md:space-y-10">
          {taggedWorks.map((work, index) => (
            <WorkCard
              name={work.name}
              description={work.description}
              image={work.image}
              url={work.url}
              tags={work.tags}
              // ğŸ’¥ æœ€ç»ˆä¿®å¤ç‚¹ï¼šä½¿ç”¨ç±»å‹æ–­è¨€ (work as any).video è§£å†³ TS 2339 é”™è¯¯
              // Nullish Coalescing (??) ç¡®ä¿ video å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œä¼ é€’ undefined
              video={(work as any).video ?? undefined} 
              isShow={work.isShow}
              layout="featured"
              index={index}
              mediaRatio="auto"
            />
          ))}
        </div>
      </section>
    )}

    {!hasBlogPosts && !hasWorks && (
      <div class="text-center text-gray-500 dark:text-gray-400 py-12">
        <p>æœªæ‰¾åˆ°åŒ…å«æ­¤æ ‡ç­¾çš„å†…å®¹ã€‚</p>
      </div>
    )}
  </div>
</Layout>
