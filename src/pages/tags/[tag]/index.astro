---
import Layout from "@/layouts/Layout.astro";
import BlogCard from "@/components/cards/BlogCard.astro";
import WorkCard from "@/components/cards/WorkCard.astro";
import { getCollection } from "astro:content";
import works from "@/collections/featuredwork.json"; 

export async function getStaticPaths() {
  const posts = await getCollection("post");
  
  const allTags = new Set<string>();
  
  posts.forEach(post => {
    if (post.data.tags && Array.isArray(post.data.tags)) {
      post.data.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  // Explicitly casting work to any for safer access later
  works.forEach((work: any) => { 
    if (work.tags && Array.isArray(work.tags) && work.isShow !== false) {
      work.tags.forEach(tag => allTags.add(tag));
    }
  });
  
  return Array.from(allTags).map(tag => ({
    params: { tag: String(tag) },
    props: { tag: String(tag) }
  }));
}

const { tag } = Astro.params;

const allPosts = await getCollection("post");
const taggedPosts = allPosts
  .filter(post => post.data.tags && Array.isArray(post.data.tags) && post.data.tags.includes(tag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

const taggedWorks = works
  .filter(work => work.tags && Array.isArray(work.tags) && work.tags.includes(tag) && work.isShow !== false);

const hasBlogPosts = taggedPosts.length > 0;
const hasWorks = taggedWorks.length > 0;
---

<Layout title={`${tag} - 标签`} description={`包含标签 "${tag}" 的文章和作品`}>
  <div class="relative site-container z-20 w-full mx-auto mt-8 px-4 md:mt-10 lg:mt-12 xl:px-0">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-4">标签: {tag}</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">
        {taggedPosts.length + taggedWorks.length} 个包含标签 "{tag}" 的内容
        {hasBlogPosts && hasWorks && ` (${taggedPosts.length} 篇文章, ${taggedWorks.length} 个作品)`}
        {hasBlogPosts && !hasWorks && ` (${taggedPosts.length} 篇文章)`}
        {!hasBlogPosts && hasWorks && ` (${taggedWorks.length} 个作品)`}
      </p>
    </div>

    {hasBlogPosts && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">相关文章</h2>
        <div class="grid gap-x-6 gap-y-10 md:grid-cols-2 xl:grid-cols-3">
          {taggedPosts.map((post, index) => (
            <BlogCard
              content={{ ...post.data, ...post } as any}
              data-aos={Math.floor(index / 3) % 2 === 0 ? "fade-right-sm" : "fade-left-sm"}
              data-aos-delay={((index % 3) + 1) * 200}
            />
          ))}
        </div>
      </section>
    )}

    {hasWorks && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6">相关作品</h2>
        <div class="space-y-8 md:space-y-10">
          {taggedWorks.map((work, index) => (
            <WorkCard
              name={work.name}
              description={work.description}
              image={work.image}
              url={work.url}
              tags={work.tags}
              // 最终的修复逻辑，干净地使用类型断言和 Nullish Coalescing 
              video={(work as any).video ?? undefined} 
              isShow={work.isShow}
              layout="featured"
              index={index}
              mediaRatio="auto"
            />
          ))}
        </div>
      </section>
    )}

    {!hasBlogPosts && !hasWorks && (
      <div class="text-center text-gray-500 dark:text-gray-400 py-12">
        <p>未找到包含此标签的内容。</p>
      </div>
    )}
  </div>
</Layout>
